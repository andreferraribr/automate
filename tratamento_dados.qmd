---
title: "Tratamento do dados"
editor: visual
lang: "pt"
format:
  # docx: default
  html:
    code-fold: true
    code-summary: "mostrar o c√≥digo"
    code-overflow: wrap
execute:
  warning: false
  message: false
---

```{r}
#| warning: false
#| message: false
#| error: false
library(readxl)
library(tidyverse)
library(janitor)
library(lubridate)
library(tidyverse)
library(purrr)
library(plotly)
library(knitr)
library(kableExtra)
library(DescTools)
library(zoo)
library(stringr)
library(DT)
library(stringr)
library(scales)
library(ggthemes)


`%notin%` <- Negate(`%in%`)
myNumFmt <- as.fmt(digits=2, big.mark=".")
options(scipen = 999)

options(DT.options = list(pageLength = 10, fontSize = "70%", language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')))
# https://rstudio.github.io/DT/004-i18n.html
# https://rstudio.github.io/DT/options.html
# %>% formatCurrency(c('A', 'C')) %>% formatPercentage('D', 2)%>% formatRound('E', 3)
```

```{r}
#| warning: false
#| message: false
#| error: false
dividir <- function(x){str_replace_all(x , c("[&]" = ";", "[|]!"= ";", "[&]!"= ";", "[|]"= ";"))}


```

```{r}
#| warning: false
#| message: false
#| error: false

dados_despesa <- read_excel("auto_despesa.xlsx", 
    col_types = c("text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "numeric", "numeric", "numeric", 
        "numeric", "numeric")) %>% clean_names()




dados_receita <- read_excel("auto_receita.xlsx") %>% clean_names()




eval_texto <- function(x){ eval(parse(text = x))}

linhas_new  <- read_excel("filtros.xlsx", sheet = "r_filtros_linhas") 

linhas_new <- linhas_new %>% filter(anexo_tabela == "anexo_04_rgps" ) %>% mutate (chave = str_c(demonstrativo,"_",anexo_tabela,"_", topico, "_",item_r))

linhas_new <- linhas_new %>% mutate (codigo_filtro = str_c(chave, " <-  dados_",topico," %>% ",filtro ," %>%  mutate (chave = ' ", chave,"')"))

linhas_receita <- linhas_new %>% filter(topico == "receita")

linhas_despesa <- linhas_new %>% filter(topico == "despesa")

linhas_receita <- map(linhas_receita$codigo_filtro, eval_texto)

df_recita <- map_df(linhas_receita, as.data.frame)

df_recita %>% group_by(chave) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE), receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)) %>% kable( digits = 2, format.args = list(big.mark = ".", decimal.mark = ","))



linhas_despesa <- map(linhas_despesa$codigo_filtro, eval_texto)

df_despesa <- map_df(linhas_despesa, as.data.frame)


df_despesa %>% group_by(chave) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE))%>% kable(  digits = getOption("digits"), format.args = list(big.mark = ".", decimal.mark = ","))


datatable(df_despesa %>% group_by(chave) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE)/1000, despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE)/1000))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho"), 0, mark = ".", dec.mark = "," )


datatable(df_recita %>% group_by(chave) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000, receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000))%>% formatRound(c("previsao_atualizada_da_receita","receita_orcamentaria_liquida"), 0, mark = ".", dec.mark = "," )

```

```{r}
datatable(dados_despesa  %>% group_by(funcao_governo_codigo, funcao_governo_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )

datatable(dados_despesa %>% filter(grupo_despesa_codigo_grupo %in% c(6) & fonte_recursos_codigo == 443 & elemento_despesa_codigo %in% c(76,77) & subfuncao_governo_codigo %in% c(841,842,843,844,846) ) %>% group_by(funcao_governo_codigo, funcao_governo_nome) %>% summarise(dotacao_atualizada = -sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = -sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = -sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )


datatable(dados_despesa %>% filter(grupo_despesa_codigo_grupo %notin% c(6)| fonte_recursos_codigo != 443 | elemento_despesa_codigo %notin% c(76,77) | subfuncao_governo_codigo %notin% c(841,842,843,844,846) ) %>% group_by(funcao_governo_codigo, funcao_governo_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )





```

```{r}

datatable(dados_despesa %>% filter (esfera_orcamentaria_codigo == 2) %>% group_by(grupo_despesa_codigo_grupo, grupo_despesa_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )

```

```{r}
datatable(dados_receita %>% filter(nre1_categoria_economica_codigo != 7)  %>% group_by(nre1_categoria_economica_codigo, nre1_categoria_economica_nome , nre2_origem_receita_codigo_origem, nre2_origem_receita_nome) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000, receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000))%>% formatRound(c("previsao_atualizada_da_receita","receita_orcamentaria_liquida"), 0, mark = ".", dec.mark = "," )


datatable(dados_receita %>%
            filter(esfera_orcamentaria_codigo ==2 ) %>% 
            mutate(
              nre1_categoria_economica_codigo = 
                case_when(nre1_categoria_economica_codigo == 7 ~ 1,
                          nre1_categoria_economica_codigo == 8 ~ 2,
                          TRUE ~ nre1_categoria_economica_codigo ),
               nre1_categoria_economica_nome = 
                case_when(nre1_categoria_economica_nome == "RECEITAS CORRENTES-INTRA" ~ "RECEITAS CORRENTES",
                          nre1_categoria_economica_nome == "8" ~ "2",
                          TRUE ~ nre1_categoria_economica_nome )) %>% 
    group_by(nre1_categoria_economica_codigo, nre1_categoria_economica_nome, nre2_origem_receita_codigo_origem) %>% 
    summarise(
      previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000,
      receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000))%>%
  formatRound(c("previsao_atualizada_da_receita","receita_orcamentaria_liquida"), 0, mark = ".", dec.mark = "," )
```

```{r}
datatable(dados_despesa %>% filter(grupo_despesa_codigo_grupo %notin% c(6)| fonte_recursos_codigo != 443 | elemento_despesa_codigo %notin% c(76,77) | subfuncao_governo_codigo %notin% c(841,842,843,844,846) ) %>% group_by(funcao_governo_codigo, funcao_governo_nome, subfuncao_governo_codigo, subfuncao_governo_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )

```
