---
title: "Tratamento do dados"
editor: visual
lang: "pt"
format:
  # docx: default
  html:
    code-fold: true
    code-summary: "mostrar o c√≥digo"
    code-overflow: wrap
execute:
  warning: false
  message: false
---

```{r}
#| warning: false
#| message: false
#| error: false
library(readxl)
library(tidyverse)
library(janitor)
library(lubridate)
library(tidyverse)
library(purrr)
library(plotly)
library(knitr)
library(kableExtra)
library(DescTools)
library(zoo)
library(stringr)
library(DT)
library(stringr)
library(scales)
library(ggthemes)


`%notin%` <- Negate(`%in%`)
myNumFmt <- as.fmt(digits=2, big.mark=".")
options(scipen = 999)

options(DT.options = list(pageLength = 10, fontSize = "70%", language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')))
# https://rstudio.github.io/DT/004-i18n.html
# https://rstudio.github.io/DT/options.html
# %>% formatCurrency(c('A', 'C')) %>% formatPercentage('D', 2)%>% formatRound('E', 3)
```

```{r}
#| warning: false
#| message: false
#| error: false
dividir <- function(x){str_replace_all(x , c("[&]" = ";", "[|]!"= ";", "[&]!"= ";", "[|]"= ";"))}


```

## Importar dados

```{r}
#| warning: false
#| message: false
#| error: false

dados_despesa <- read_excel("auto_despesa.xlsx") %>% clean_names()


dados_receita <- read_excel("auto_receita.xlsx") %>% clean_names()


dados_conta_contabil <- read_excel("auto_conta_contabil.xlsx") %>% clean_names()


dados_restos_a_pagar <- read_excel("auto_restos_a_pagar.xlsx") %>% clean_names()







# (df_receita %>% group_by(chave) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000, receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000))%>% formatRound(c("previsao_atualizada_da_receita","receita_orcamentaria_liquida"), 0, mark = ".", dec.mark = "," )

```

## Importar planilha com filtros da metodologia

```{r}
eval_texto <- function(x){ eval(parse(text = x))}

filtros_metodologia  <- read_excel("filtros.xlsx", sheet = "r_filtros_linhas") 

filtros_metodologia <- filtros_metodologia %>% filter(anexo_tabela == "anexo_04_rgps" ) %>% mutate (chave = str_c(demonstrativo,"_",anexo_tabela,"_", topico, "_",item_r))

filtros_metodologia <- filtros_metodologia %>% mutate (codigo_filtro = str_c(chave, " <-  dados_",topico," %>% ",filtro ," %>%  mutate (chave = ' ", chave,"')"))


```

## Criar base de dados a partir dos filtros

### df_receita

```{r}
filtros_receita<- filtros_metodologia %>% filter(topico == "receita")


dados_receita_filtrados<- map(filtros_receita$codigo_filtro, eval_texto)

df_receita <- map_df(dados_receita_filtrados, as.data.frame)

df_receita %>% group_by(chave) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE), receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)) %>% kable( digits = 2, format.args = list(big.mark = ".", decimal.mark = ","))





```

### df_despesa

```{r}
filtros_despesa <- filtros_metodologia %>% filter(topico == "despesa")


dados_despesa_filtrados <- map(filtros_despesa$codigo_filtro, eval_texto)

df_despesa <- map_df(dados_despesa_filtrados, as.data.frame)


df_despesa %>% group_by(chave) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE))%>% kable(  digits = getOption("digits"), format.args = list(big.mark = ".", decimal.mark = ","))


datatable(df_despesa %>% group_by(chave) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE)/1000, despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE)/1000))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho"), 0, mark = ".", dec.mark = "," )
```

```{r}
# datatable(dados_despesa  %>% group_by(funcao_governo_codigo, funcao_governo_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )
# 
# datatable(dados_despesa %>% filter(grupo_despesa_codigo_grupo %in% c(6) & fonte_recursos_codigo == 443 & elemento_despesa_codigo %in% c(76,77) & subfuncao_governo_codigo %in% c(841,842,843,844,846) ) %>% group_by(funcao_governo_codigo, funcao_governo_nome) %>% summarise(dotacao_atualizada = -sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = -sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = -sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )








```

```{r}
#| warning: false
#| message: false
#| error: false
#| eval: false

datatable(dados_despesa %>% filter(grupo_despesa_codigo_grupo %notin% c(6)| fonte_recursos_codigo != 443 | elemento_despesa_codigo %notin% c(76,77) | subfuncao_governo_codigo %notin% c(841,842,843,844,846) ) %>% group_by(funcao_governo_codigo, funcao_governo_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )


datatable(dados_despesa %>% filter (esfera_orcamentaria_codigo == 2) %>% group_by(grupo_despesa_codigo_grupo, grupo_despesa_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )




```

```{r}
#| warning: false
#| message: false
#| error: false
#| eval: false

datatable(dados_despesa %>% filter(resultado_eof_codigo == 6) %>% group_by(orgao_uge_orgao_maximo_codigo,orgao_uge_orgao_maximo_nome)%>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )
```

```{r}
#| warning: false
#| message: false
#| error: false
#| eval: false
datatable(dados_receita %>% filter(nre1_categoria_economica_codigo != 7)  %>% group_by(nre1_categoria_economica_codigo, nre1_categoria_economica_nome , nre2_origem_receita_codigo_origem, nre2_origem_receita_nome) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000, receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000))%>% formatRound(c("previsao_atualizada_da_receita","receita_orcamentaria_liquida"), 0, mark = ".", dec.mark = "," )


datatable(dados_receita %>%
            filter(esfera_orcamentaria_codigo ==2 ) %>% 
            mutate(
              nre1_categoria_economica_codigo = 
                case_when(nre1_categoria_economica_codigo == 7 ~ 1,
                          nre1_categoria_economica_codigo == 8 ~ 2,
                          TRUE ~ nre1_categoria_economica_codigo ),
               nre1_categoria_economica_nome = 
                case_when(nre1_categoria_economica_nome == "RECEITAS CORRENTES-INTRA" ~ "RECEITAS CORRENTES",
                          nre1_categoria_economica_nome == "8" ~ "2",
                          TRUE ~ nre1_categoria_economica_nome )) %>% 
    group_by(nre1_categoria_economica_codigo, nre1_categoria_economica_nome, nre2_origem_receita_codigo_origem) %>% 
    summarise(
      previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000,
      receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000))%>%
  formatRound(c("previsao_atualizada_da_receita","receita_orcamentaria_liquida"), 0, mark = ".", dec.mark = "," )
```

```{r}
#| warning: false
#| message: false
#| error: false
#| eval: false
datatable(dados_despesa %>% filter(grupo_despesa_codigo_grupo %notin% c(6)| fonte_recursos_codigo != 443 | elemento_despesa_codigo %notin% c(76,77) | subfuncao_governo_codigo %notin% c(841,842,843,844,846) ) %>% group_by(funcao_governo_codigo, funcao_governo_nome, subfuncao_governo_codigo, subfuncao_governo_nome) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE), despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE),despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)))%>% formatRound(c("dotacao_atualizada","despesas_empenhadas_controle_empenho", "despesas_liquidadas_controle_empenho"), 0, mark = ".", dec.mark = "," )

```

```{r}
# auto_restos_a_pagar <- read_excel("auto_restos_a_pagar.xlsx") %>% clean_names()
# 
# datatable(auto_restos_a_pagar %>% filter($) %>% group_by(ne_c_cor_ano_emissao) %>% summarise(restos_a_pagar_nao_processados_inscritos = sum(restos_a_pagar_nao_processados_inscritos, na.rm = TRUE)/1000, restos_a_pagar_processados_inscritos = sum(restos_a_pagar_processados_inscritos, na.rm = TRUE)/1000))%>% formatRound(c("restos_a_pagar_nao_processados_inscritos","restos_a_pagar_processados_inscritos"), 0, mark = ".", dec.mark = "," )
```

```{r}
#| warning: false
#| message: false
#| error: false
#| eval: false
datatable(dados_despesa %>%filter (elemento_despesa_codigo %notin% c(76,77)) %>% group_by(uf_pt_sigla, funcao_governo_codigo, funcao_governo_nome, subfuncao_governo_codigo, subfuncao_governo_nome) %>% summarise(despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE)/1000))%>% formatRound(c("despesas_empenhadas_controle_empenho"), 0, mark = ".", dec.mark = "," )
```

```{r}
library(openxlsx)

# https://www.youtube.com/watch?v=SDV2jB731Fo

wb <- createWorkbook()

addWorksheet(wb, "receitas")
addWorksheet(wb, "despesas")
addWorksheet(wb, "conta_contabil")
addWorksheet(wb, "restos_a_pagar")

writeData(wb, "receitas",df_receita %>% group_by(chave) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000000, receita_orcamentaria_liquida = sum(receita_orcamentaria_liquida, na.rm = TRUE)/1000000) )

writeData(wb, "despesas",df_despesa %>% group_by(chave) %>% summarise(dotacao_atualizada = sum(dotacao_atualizada, na.rm = TRUE)/1000000, despesas_empenhadas_controle_empenho = sum(despesas_empenhadas_controle_empenho, na.rm = TRUE)/1000000, despesas_liquidadas_controle_empenho = sum(despesas_liquidadas_controle_empenho, na.rm = TRUE)/1000000, despesas_pagas_controle_empenho = sum(despesas_pagas_controle_empenho, na.rm = TRUE)/1000000) )

saveWorkbook(wb, file = "dados_salvos.xlsx", overwrite = TRUE)
```
