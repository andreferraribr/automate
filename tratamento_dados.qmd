---
title: "Tratamento do dados"
editor: visual
lang: "pt"
format:
  # docx: default
  html:
    code-fold: true
    code-summary: "mostrar o código"
    code-overflow: wrap
execute:
  warning: false
  message: false
---

```{r}
#| warning: false
#| message: false
#| error: false
library(readxl)
library(tidyverse)
library(janitor)
library(lubridate)
library(tidyverse)
library(purrr)
library(plotly)
library(knitr)
library(kableExtra)
library(DescTools)
library(zoo)
library(stringr)
library(DT)
library(stringr)
library(scales)
library(ggthemes)


`%notin%` <- Negate(`%in%`)
myNumFmt <- as.fmt(digits=0, big.mark=".")
options(scipen = 999)

options(DT.options = list(pageLength = 10, fontSize = "70%", language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Portuguese.json')))
# https://rstudio.github.io/DT/004-i18n.html
# https://rstudio.github.io/DT/options.html
# %>% formatCurrency(c('A', 'C')) %>% formatPercentage('D', 2)%>% formatRound('E', 3)
```

## Importar metodologia

### Metodologia geral dos Anexos e Tabelas

```{r importar_metodologia_anexos_tabelas}
#| warning: false
#| message: false
#| error: false


filtros_gerais_anexos_tabelas  <- read_excel("filtros.xlsx", sheet = "filtros_gerais_anexos_tabelas")

filtros_gerais_anexos_tabelas %>% head() %>% kable()






```

### Metodologia geral das Linhas

```{r}
#| warning: false
#| message: false
#| error: false

filtros_linhas <- read_excel("filtros.xlsx", sheet = "filtros_linhas")

filtros_linhas %>% head()%>% kable()



```

## Importar dados consolidados da receita e da despesa

```{r importar_dados}
#| warning: false
#| message: false
#| error: false
auto_despesa <- read_excel("auto_despesa.xlsx", 
    col_types = c("text", "numeric", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "numeric", "numeric", "numeric", 
        "numeric", "numeric")) %>% clean_names()




dados_receita <- read_excel("auto_receita.xlsx") %>% clean_names()







```

## "Limpar" os nomes dos atributos do Tesouro Gerencial

```{r atributos_tg_clean}
#| warning: false
#| message: false
#| error: false

atributos_despesa_tg <- colnames(auto_despesa)


atributos_receita_tg <- colnames(dados_receita)


atributos_nomes_tg <- cbind(c(atributos_despesa_tg,atributos_receita_tg) %>% unique(),c(atributos_despesa_tg,atributos_receita_tg) %>% unique() %>% make_clean_names())


```

## Criar código com os filtros gerais dos Anexos e das Tabelas

![](sequencial_na.png)

```{r}
#| warning: false
#| message: false
#| error: false



filtros_gerais_anexos_tabelas <- filtros_gerais_anexos_tabelas %>%
   mutate(operador_logico_r = str_replace_na(operador_logico_r)  )

criar_codigo_filtros_gerais_anexos_tabelas <- filtros_gerais_anexos_tabelas %>%
  mutate(
    operador_logico_r = 
      str_replace_all(operador_logico_r, "NA", " "))  %>%
  mutate(filtro = 
           str_c(operador_logico_r,
                 " ",
                 atributo_r,
                 " " ,
                 operador_comparacao_r,
                 " " ,
                 valores)) %>% 
  group_by(anexo_tabela, topico,sequencial,filtro)  %>%
  summarise() %>%
  drop_na()





criar_codigo_filtros_gerais_anexos_tabelas %>% kable()
```

```{r}
criar_codigo_filtros_gerais_anexos_tabelas <- criar_codigo_filtros_gerais_anexos_tabelas  %>%
   pivot_wider(
     names_from = sequencial,
     values_from = filtro) %>%
   unite(
     col= filtrao,
     !c("anexo_tabela", "topico"), sep = ' ') %>%
   mutate (filtrao = str_remove(filtrao, " NA"))%>%
   mutate(
     filtrao = 
       str_c(
         anexo_tabela,
         " <- dados_receita %>%  filter( ",
         filtrao,
         " )" 
         ,
        " %>% mutate (anexo_tabela_topico = '",
        anexo_tabela,"_",topico,"')"
         )) %>%
   mutate (filtrao = str_remove(filtrao, " NA"))


criar_codigo_filtros_gerais_anexos_tabelas %>% kable()
```

```{r}
eval_texto <- function(x){ eval(parse(text = x))}

lista_dados_anexos_tabelas <- map(criar_codigo_filtros_gerais_anexos_tabelas$filtrao, eval_texto)


names(lista_dados_anexos_tabelas) <- criar_codigo_filtros_gerais_anexos_tabelas$anexo_tabela
```

## Criar código com os filtros para as linhas individuais dos Anexos e das Tabelas

```{r}
#| warning: false
#| message: false
#| error: false


 filtros_linhas <- filtros_linhas %>% mutate(operador_logico_r = str_replace_na(operador_logico_r)  )
 
 
 
 

criar_codigo_filtros_linhas <- filtros_linhas %>% filter(topico == "receitas") %>%mutate(operador_logico_r = str_replace_all(operador_logico_r, "NA", " "))  %>% mutate(filtro = str_c(operador_logico_r, " ",atributo_r," " ,operador_comparacao_r, " " ,valores)) %>% group_by(anexo_tabela, topico, item, sequencial,filtro)  %>% summarise() %>% drop_na() %>% mutate(item = item %>% make_clean_names()) %>% mutate(nome_linha = str_c(anexo_tabela,"_",topico, "_", item))

 criar_codigo_filtros_linhas %>% kable()

# names_linhas <- criar_codigo_filtros_linhas %>% mutate(nome_linha = str_c(anexo_tabela,"_",topico, "_", item)) %>%  group_by(nome_linha) %>% summarise() 




```

```{r}
#| warning: false
#| message: false
#| error: false
criar_codigo_filtros_linhas <- criar_codigo_filtros_linhas  %>%
   pivot_wider(
     names_from = sequencial,
     values_from = filtro) %>%
   unite(
     col= filtrao,
     !c("anexo_tabela","topico" ,"item", "nome_linha"), sep = ' ') %>%
   mutate (filtrao = str_remove(filtrao, " NA"))%>%
   mutate(
     filtrao = 
       str_c(
         anexo_tabela,
         "_",
         topico,
         "_",
         item,
        " <- lista_dados_anexos_tabelas$",
        anexo_tabela,
         "%>%  filter( ",
         filtrao,
         " )" ,
        " %>% mutate (anexo_tabela_topico_linha = '",
        anexo_tabela,"_",topico,"_",item,"')"
           
         )) %>%
   mutate (filtrao = str_remove(filtrao, " NA"))


 criar_codigo_filtros_linhas %>% kable()


```

```{r}
#| warning: false
#| message: false
#| error: false


lista_linhas <- map(criar_codigo_filtros_linhas$filtrao, eval_texto)




# names(lista_linhas) <- names_linhas$nome_linha


df_linhas <- map_df(lista_linhas, as.data.frame)

df_linhas%>% group_by(anexo_tabela_topico_linha) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000000000)%>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ","))
```

```{r}
#| warning: false
#| message: false
#| error: false
#| eval: false
receita_total <-  for (i in seq_along(lista_dados_anexos_tabelas)) {
  print( sum(lista_dados_anexos_tabelas[[i]][21], na.rm = TRUE)/1000000000  )
  
}

anexos <- for (i in seq_along(lista_dados_anexos_tabelas)) {
  names(lista_dados_anexos_tabelas)
}

df_anexos_tabelas <- map_df(lista_dados_anexos_tabelas, as.data.frame)

df_anexos_tabelas%>% group_by(anexo_tabela_topico) %>% summarise(previsao_atualizada_da_receita = sum(previsao_atualizada_da_receita, na.rm = TRUE)/1000000000)%>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ","))
```
